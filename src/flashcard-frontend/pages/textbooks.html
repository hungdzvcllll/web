<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Sách giáo khoa - FlashCard</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="../css/style.css" rel="stylesheet">
</head>
<body>
  <div id="navbar-container"></div>
  <div id="sidebar-container"></div>

  <main class="main-content">
    <div class="page-header d-flex justify-content-between align-items-center">
      <div>
        <h1>Sách giáo khoa</h1>
        <p>Danh mục sách giáo khoa / tài liệu tham khảo.</p>
      </div>
      <div id="textbook-actions"></div>
    </div>

    <div id="textbooks-container" class="row g-4">
      <div class="col-12"><div class="loading-spinner"><div class="spinner"></div></div></div>
    </div>

    <div id="pagination-container" class="mt-4"></div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="../js/config.js"></script>
  <script src="../js/api.js"></script>
  <script src="../js/utils.js"></script>
  <script src="../js/app.js"></script>

  <script>
    let currentPage = 0;

    document.addEventListener('DOMContentLoaded', async () => {
      if (!Utils.requireAuth()) return;
      renderActions();
      await loadTextBooks(0);
    });

    function renderActions() {
      const raw = localStorage.getItem(CONFIG.STORAGE.USER);
      let role = null;
      if (raw) {
          try { role = JSON.parse(raw).role; } catch(e) { role = null; }
      }
      // hiển thị cho ADMIN / TEACHER (tùy bạn)
      if (role === 'ROLE_ADMIN' || role === 'ROLE_TEACHER') {
          document.getElementById('textbook-actions').innerHTML = `
            <button class="btn btn-primary-custom" onclick="showAddModal()">
              <i class="fas fa-plus me-1"></i> Thêm sách
            </button>
          `;
      } else {
          document.getElementById('textbook-actions').innerHTML = '';
      }
    }

    function showAddModal() {
      const name = prompt('Tên sách giáo khoa:');
      if (!name) return;
      API.addTextbook(name)
        .then(() => {
          Utils.success('Thêm sách thành công');
          loadTextBooks(currentPage);
        })
        .catch(err => Utils.error(err.message || 'Không thể thêm'));
    }

    async function loadTextBooks(page = 0) {
      currentPage = page;
      const container = document.getElementById('textbooks-container');
      container.innerHTML = '<div class="col-12"><div class="loading-spinner"><div class="spinner"></div></div></div>';

      try {
        const resp = await API.getAllTextbooks(page, CONFIG.DEFAULT_PAGE_SIZE);
        const items = resp.content || [];

        if (items.length === 0) {
          container.innerHTML = `<div class="col-12"><div class="empty-state">
            <div class="empty-state-icon"><i class="fas fa-book"></i></div>
            <h3>Chưa có sách</h3>
            <p>Hiện chưa có sách giáo khoa nào.</p>
          </div></div>`;
          Utils.renderPagination('#pagination-container', page, resp.totalPages || 0, loadTextBooks);
          return;
        }

        container.innerHTML = items.map(book => `
          <div class="col-sm-6 col-lg-4">
            <div class="card-custom h-100">
              <div class="card-body d-flex flex-column">
                <div class="d-flex justify-content-between align-items-start">
                  <h5 class="mb-2">${Utils.escapeHtml(book.name)}</h5>
                  <small class="text-muted">#${book.id}</small>
                </div>
                <p class="text-muted mb-3">Tác giả: ${Utils.escapeHtml(book.authorName || '—')}</p>
                <div class="mt-auto d-flex gap-2">
                  <a class="btn btn-outline-primary btn-sm" href="textbooks-detail.html?id=${book.id}"><i class="fas fa-eye me-1"></i> Xem</a>
                </div>
              </div>
            </div>
          </div>
        `).join('');

        Utils.renderPagination('#pagination-container', page, resp.totalPages, loadTextBooks);
      } catch (e) {
        container.innerHTML = `<div class="col-12"><p class="text-center text-muted">Không thể tải dữ liệu</p></div>`;
      }
    }
  </script>
</body>
</html>