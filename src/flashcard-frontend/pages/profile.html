<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hồ sơ - FlashCard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="../css/style.css" rel="stylesheet">
</head>
<body>
    <div id="navbar-container"></div>
    <div id="sidebar-container"></div>
    
    <main class="main-content">
        <div class="page-header">
            <h1>Hồ sơ cá nhân</h1>
            <p>Quản lý thông tin tài khoản của bạn</p>
        </div>
        
        <div class="row">
            <div class="col-lg-4 mb-4">
                <div class="card-custom text-center">
                    <div class="card-body py-5">
                        <div class="user-avatar mx-auto mb-3" id="profile-avatar" style="width: 100px; height: 100px; font-size: 2.5rem;">U</div>
                        <h4 id="profile-username">Loading...</h4>
                        <p class="text-muted" id="profile-email">loading@email.com</p>
                        <span class="badge badge-primary" id="profile-role">USER</span>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-8">
                <div class="card-custom mb-4">
                    <div class="card-body">
                        <h5 class="card-title mb-4"><i class="fas fa-user-edit me-2"></i>Cập nhật thông tin</h5>
                        <form id="update-profile-form">
                            <div class="mb-3">
                                <label class="form-label">Tên đăng nhập</label>
                                <input type="text" class="form-control" id="input-username" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-control" id="input-email" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Mật khẩu mới (để trống nếu không đổi)</label>
                                <input type="password" class="form-control" id="input-password" placeholder="Nhập mật khẩu mới">
                            </div>
                            <button type="submit" class="btn btn-primary-custom">
                                <i class="fas fa-save me-1"></i> Lưu thay đổi
                            </button>
                        </form>
                    </div>
                </div>
                
                <div class="card-custom">
                    <div class="card-body">
                        <h5 class="card-title mb-4"><i class="fas fa-crown text-warning me-2"></i>Gói VIP</h5>
                        <div id="vip-status">
                            <div class="loading-spinner"><div class="spinner"></div></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/config.js"></script>
    <script src="../js/api.js"></script>
    <script src="../js/utils.js"></script>
    <script src="../js/app.js"></script>
    
    <script>
        let userData;
        
        document.addEventListener('DOMContentLoaded', async function() {
            if (!Utils.requireAuth()) return;
            await loadProfile();
            await loadVipStatus();
            setupEventListeners();
        });
        
        async function loadProfile() {
            try {
                userData = await API.getProfile();
                document.getElementById('profile-avatar').textContent = Utils.getInitials(userData.username);
                document.getElementById('profile-username').textContent = userData.username;
                document.getElementById('profile-email').textContent = userData.email;
                document.getElementById('profile-role').textContent = userData.role?.replace('ROLE_', '') || 'USER';
                
                document.getElementById('input-username').value = userData.username;
                document.getElementById('input-email').value = userData.email;
                
                localStorage.setItem(CONFIG.STORAGE.USER, JSON.stringify(userData));
            } catch (error) {
                Utils.error('Không thể tải thông tin');
            }
        }
        
        async function loadVipStatus() {
            const container = document.getElementById('vip-status');
            try {
                const response = await API.getYourVipHistory(0, 1);
                const vips = response.content || [];
                const activeVip = vips.find(v => new Date(v.expired) > new Date());
                
                if (activeVip) {
                    container.innerHTML = `
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle me-2"></i>
                            <strong>VIP đang hoạt động!</strong>
                            <p class="mb-0 small">Hết hạn: ${Utils.formatDate(activeVip.expired, 'datetime')}</p>
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <div class="alert alert-warning">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Bạn chưa có gói VIP</strong>
                            <p class="mb-2 small">Nâng cấp VIP để sử dụng đầy đủ tính năng Quiz</p>
                            <a href="vip.html" class="btn btn-sm btn-warning"><i class="fas fa-crown me-1"></i> Nâng cấp VIP</a>
                        </div>
                    `;
                }
            } catch (error) {
                container.innerHTML = '<p class="text-muted">Không thể tải thông tin VIP</p>';
            }
        }
        
        function setupEventListeners() {
            document.getElementById('update-profile-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                const username = document.getElementById('input-username').value.trim();
                const email = document.getElementById('input-email').value.trim();
                const password = document.getElementById('input-password').value;
                
                if (!username || !email) { Utils.error('Vui lòng nhập đầy đủ'); return; }
                
                try {
                    await API.updateProfile(username, password || undefined, email);
                    Utils.success('Cập nhật thành công!');
                    document.getElementById('input-password').value = '';
                    loadProfile();
                } catch (error) { Utils.error(error.message || 'Lỗi'); }
            });
        }
    </script>
</body>
</html>