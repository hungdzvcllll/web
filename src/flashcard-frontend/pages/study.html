<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Học Flashcard - FlashCard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="../css/style.css" rel="stylesheet">
</head>
<body>
    <div id="navbar-container"></div>
    <div id="sidebar-container"></div>
    
    <main class="main-content">
        <div class="page-header text-center">
            <h1 id="studyset-title">Đang tải...</h1>
            <p id="studyset-info">Học với flashcard</p>
        </div>
        
        <!-- Progress -->
        <div class="mb-4">
            <div class="d-flex justify-content-between mb-2">
                <span id="progress-text">Thẻ 0 / 0</span>
                <span id="progress-percent">0%</span>
            </div>
            <div class="progress-custom">
                <div class="progress-bar" id="progress-bar" style="width: 0%"></div>
            </div>
        </div>
        
        <!-- Flashcard -->
        <div class="flashcard-container mb-4" id="flashcard-wrapper">
            <div class="flashcard" id="flashcard" onclick="flipCard()">
                <div class="flashcard-face flashcard-front">
                    <div class="flashcard-label">KHÁI NIỆM</div>
                    <div class="flashcard-content" id="card-front">Đang tải...</div>
                    <div class="flashcard-hint"><i class="fas fa-hand-pointer"></i> Click để lật thẻ</div>
                </div>
                <div class="flashcard-face flashcard-back">
                    <div class="flashcard-label">ĐỊNH NGHĨA</div>
                    <div class="flashcard-content" id="card-back">Đang tải...</div>
                    <div class="flashcard-hint"><i class="fas fa-hand-pointer"></i> Click để lật thẻ</div>
                </div>
            </div>
        </div>
        
        <!-- Navigation -->
        <div class="flashcard-nav">
            <button class="btn-nav" id="btn-prev" onclick="prevCard()" disabled>
                <i class="fas fa-chevron-left"></i>
            </button>
            <div class="flashcard-counter" id="counter">0 / 0</div>
            <button class="btn-nav" id="btn-next" onclick="nextCard()">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
        
        <!-- Action Buttons -->
        <div class="text-center mt-4">
            <button class="btn btn-outline-danger me-2" onclick="markAsHard()">
                <i class="fas fa-times me-1"></i> Chưa nhớ
            </button>
            <button class="btn btn-outline-success me-2" onclick="markAsEasy()">
                <i class="fas fa-check me-1"></i> Đã nhớ
            </button>
            <button class="btn btn-outline-primary" onclick="shuffleCards()">
                <i class="fas fa-random me-1"></i> Xáo trộn
            </button>
        </div>
        
        <!-- Quick Actions -->
        <div class="text-center mt-4">
            <a href="#" id="btn-quiz" class="btn btn-primary-custom">
                <i class="fas fa-clipboard-check me-1"></i> Làm Quiz
            </a>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/config.js"></script>
    <script src="../js/api.js"></script>
    <script src="../js/utils.js"></script>
    <script src="../js/app.js"></script>
    
    <script>
        let studySetId;
        let flashcards = [];
        let currentIndex = 0;
        let isFlipped = false;
        let remembered = new Set();
        
        document.addEventListener('DOMContentLoaded', async function() {
            if (!Utils.requireAuth()) return;
            
            studySetId = Utils.getUrlParam('id');
            if (!studySetId) {
                Utils.error('Không tìm thấy bộ học');
                window.location.href = 'folders.html';
                return;
            }
            
            document.getElementById('btn-quiz').href = `quiz.html?id=${studySetId}`;
            
            await loadStudySet();
            await loadFlashcards();
            
            // Keyboard navigation
            document.addEventListener('keydown', handleKeyboard);
        });
        
        async function loadStudySet() {
            try {
                const data = await API.getStudySetById(studySetId);
                document.getElementById('studyset-title').textContent = data.name;
            } catch (error) {
                Utils.error('Không thể tải thông tin');
            }
        }
        
        async function loadFlashcards() {
            try {
                const response = await API.getFlashcardsByStudySet(studySetId);
                flashcards = response.content || [];
                
                if (flashcards.length === 0) {
                    document.getElementById('flashcard-wrapper').innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon"><i class="fas fa-clone"></i></div>
                            <h3>Chưa có thẻ nào</h3>
                            <p>Bộ học này chưa có flashcard</p>
                            <a href="studyset-detail.html?id=${studySetId}" class="btn btn-primary-custom">
                                <i class="fas fa-plus me-1"></i> Thêm thẻ
                            </a>
                        </div>
                    `;
                    return;
                }
                
                document.getElementById('studyset-info').textContent = `${flashcards.length} thẻ`;
                updateCard();
                updateProgress();
            } catch (error) {
                Utils.error('Không thể tải flashcard');
            }
        }
        
        function updateCard() {
            if (flashcards.length === 0) return;
            
            const card = flashcards[currentIndex];
            document.getElementById('card-front').textContent = card.concept;
            document.getElementById('card-back').textContent = card.define;
            document.getElementById('counter').textContent = `${currentIndex + 1} / ${flashcards.length}`;
            
            // Reset flip
            isFlipped = false;
            document.getElementById('flashcard').classList.remove('flipped');
            
            // Update navigation buttons
            document.getElementById('btn-prev').disabled = currentIndex === 0;
            document.getElementById('btn-next').disabled = currentIndex === flashcards.length - 1;
            
            updateProgress();
        }
        
        function updateProgress() {
            const percent = Math.round(((currentIndex + 1) / flashcards.length) * 100);
            document.getElementById('progress-text').textContent = `Thẻ ${currentIndex + 1} / ${flashcards.length}`;
            document.getElementById('progress-percent').textContent = `${percent}%`;
            document.getElementById('progress-bar').style.width = `${percent}%`;
        }
        
        function flipCard() {
            isFlipped = !isFlipped;
            document.getElementById('flashcard').classList.toggle('flipped');
        }
        
        function nextCard() {
            if (currentIndex < flashcards.length - 1) {
                currentIndex++;
                updateCard();
            }
        }
        
        function prevCard() {
            if (currentIndex > 0) {
                currentIndex--;
                updateCard();
            }
        }
        
        function markAsEasy() {
            remembered.add(flashcards[currentIndex].id);
            Utils.success('Đã đánh dấu "Đã nhớ"');
            if (currentIndex < flashcards.length - 1) {
                nextCard();
            }
        }
        
        function markAsHard() {
            remembered.delete(flashcards[currentIndex].id);
            Utils.info('Đã đánh dấu "Chưa nhớ"');
            if (currentIndex < flashcards.length - 1) {
                nextCard();
            }
        }
        
        function shuffleCards() {
            flashcards = Utils.shuffleArray(flashcards);
            currentIndex = 0;
            updateCard();
            Utils.success('Đã xáo trộn thẻ!');
        }
        
        function handleKeyboard(e) {
            switch(e.key) {
                case 'ArrowLeft':
                    prevCard();
                    break;
                case 'ArrowRight':
                    nextCard();
                    break;
                case ' ':
                case 'Enter':
                    e.preventDefault();
                    flipCard();
                    break;
                case '1':
                    markAsHard();
                    break;
                case '2':
                    markAsEasy();
                    break;
            }
        }
    </script>
    
    <style>
        .main-content {
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            padding-top: 2rem;
        }
        @media (min-width: 992px) {
            .main-content {
                margin-left: calc(260px + (100% - 260px - 800px) / 2);
            }
        }
    </style>
</body>
</html>