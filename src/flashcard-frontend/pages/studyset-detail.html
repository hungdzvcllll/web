<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chi tiết bộ học - FlashCard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="../css/style.css" rel="stylesheet">
</head>
<body>
    <div id="navbar-container"></div>
    <div id="sidebar-container"></div>
    
    <main class="main-content">
        <div class="page-header">
            <nav class="breadcrumb-custom"><ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="dashboard.html">Trang chủ</a></li>
                <li class="breadcrumb-item"><a href="folders.html">Thư mục</a></li>
                <li class="breadcrumb-item active" id="breadcrumb-name">Loading...</li>
            </ol></nav>
            <div class="d-flex justify-content-between align-items-start flex-wrap gap-3">
                <div>
                    <h1 id="studyset-title"><i class="fas fa-layer-group text-primary me-2"></i>Loading...</h1>
                    <p id="studyset-count">0 thẻ</p>
                </div>
                <div class="d-flex gap-2 flex-wrap">
                    <a href="#" id="btn-study" class="btn btn-outline-primary"><i class="fas fa-graduation-cap me-1"></i> Học</a>
                    <a href="#" id="btn-quiz" class="btn btn-outline-success"><i class="fas fa-clipboard-check me-1"></i> Quiz</a>
                    <button class="btn btn-primary-custom" onclick="showAddCardModal()">
                        <i class="fas fa-plus me-1"></i> Thêm thẻ
                    </button>
                </div>
            </div>
        </div>
        
        <div id="flashcards-container" class="row g-3">
            <div class="col-12"><div class="loading-spinner"><div class="spinner"></div></div></div>
        </div>
    </main>
    
    <!-- Add/Edit Card Modal -->
    <div class="modal fade modal-custom" id="cardModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="cardModalTitle">Thêm thẻ mới</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="card-form">
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="card-concept" class="form-label">Khái niệm (Mặt trước)</label>
                                <textarea class="form-control" id="card-concept" rows="4" placeholder="Nhập khái niệm, câu hỏi..." required></textarea>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="card-define" class="form-label">Định nghĩa (Mặt sau)</label>
                                <textarea class="form-control" id="card-define" rows="4" placeholder="Nhập định nghĩa, câu trả lời..." required></textarea>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="card-image" class="form-label">Hình ảnh (tùy chọn)</label>
                            <input type="file" class="form-control" id="card-image" accept="image/*">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Hủy</button>
                        <button type="submit" class="btn btn-primary-custom" id="card-submit-btn">
                            <i class="fas fa-save me-1"></i> Lưu
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/config.js"></script>
    <script src="../js/api.js"></script>
    <script src="../js/utils.js"></script>
    <script src="../js/app.js"></script>
    
    <script>
        let cardModal;
        let studySetId, studySetData;
        let editingCardId = null;
        
        document.addEventListener('DOMContentLoaded', async function() {
            if (!Utils.requireAuth()) return;
            
            studySetId = Utils.getUrlParam('id');
            if (!studySetId) {
                Utils.error('Không tìm thấy bộ học');
                window.location.href = 'folders.html';
                return;
            }
            
            cardModal = new bootstrap.Modal(document.getElementById('cardModal'));
            
            await loadStudySetDetail();
            await loadFlashcards();
            setupEventListeners();
        });
        
        async function loadStudySetDetail() {
            try {
                studySetData = await API.getStudySetById(studySetId);
                document.getElementById('studyset-title').innerHTML = `<i class="fas fa-layer-group text-primary me-2"></i>${Utils.escapeHtml(studySetData.name)}`;
                document.getElementById('breadcrumb-name').textContent = studySetData.name;
                document.getElementById('btn-study').href = `study.html?id=${studySetId}`;
                document.getElementById('btn-quiz').href = `quiz.html?id=${studySetId}`;
            } catch (error) {
                Utils.error('Không thể tải thông tin');
            }
        }
        
        async function loadFlashcards() {
            const container = document.getElementById('flashcards-container');
            container.innerHTML = '<div class="col-12"><div class="loading-spinner"><div class="spinner"></div></div></div>';
            
            try {
                const response = await API.getFlashcardsByStudySet(studySetId);
                const cards = response.content || [];
                
                document.getElementById('studyset-count').textContent = `${cards.length} thẻ`;
                
                if (cards.length === 0) {
                    container.innerHTML = `<div class="col-12"><div class="empty-state">
                        <div class="empty-state-icon"><i class="fas fa-clone"></i></div>
                        <h3>Chưa có thẻ nào</h3>
                        <p>Thêm thẻ flashcard đầu tiên</p>
                        <button class="btn btn-primary-custom" onclick="showAddCardModal()"><i class="fas fa-plus me-1"></i> Thêm thẻ</button>
                    </div></div>`;
                    return;
                }
                
                container.innerHTML = cards.map((card, index) => `
                    <div class="col-12">
                        <div class="card-custom">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-auto">
                                        <span class="badge bg-secondary">${index + 1}</span>
                                    </div>
                                    <div class="col-md-5">
                                        <div class="fw-semibold text-primary small mb-1">KHÁI NIỆM</div>
                                        <div>${Utils.escapeHtml(card.concept)}</div>
                                    </div>
                                    <div class="col-md-5">
                                        <div class="fw-semibold text-success small mb-1">ĐỊNH NGHĨA</div>
                                        <div>${Utils.escapeHtml(card.define)}</div>
                                    </div>
                                    <div class="col-auto">
                                        <div class="dropdown">
                                            <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="dropdown">
                                                <i class="fas fa-ellipsis-v"></i>
                                            </button>
                                            <ul class="dropdown-menu dropdown-menu-end">
                                                <li><a class="dropdown-item" href="#" onclick="editCard(${card.id}, '${Utils.escapeHtml(card.concept).replace(/'/g, "\\'")}', '${Utils.escapeHtml(card.define).replace(/'/g, "\\'")}')"><i class="fas fa-edit me-2"></i>Sửa</a></li>
                                                <li><a class="dropdown-item text-danger" href="#" onclick="deleteCard(${card.id})"><i class="fas fa-trash me-2"></i>Xóa</a></li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                container.innerHTML = '<div class="col-12"><p class="text-center text-muted">Không thể tải dữ liệu</p></div>';
            }
        }
        
        function setupEventListeners() {
            document.getElementById('card-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const concept = document.getElementById('card-concept').value.trim();
                const define = document.getElementById('card-define').value.trim();
                const imageFile = document.getElementById('card-image').files[0];
                
                if (!concept || !define) {
                    Utils.error('Vui lòng nhập đầy đủ');
                    return;
                }
                
                try {
                    if (editingCardId) {
                        await API.updateFlashcard(editingCardId, concept, define, imageFile);
                        Utils.success('Cập nhật thành công!');
                    } else {
                        await API.addFlashcard(studySetId, concept, define, imageFile);
                        Utils.success('Thêm thẻ thành công!');
                    }
                    cardModal.hide();
                    resetCardForm();
                    loadFlashcards();
                } catch (error) {
                    Utils.error(error.message || 'Lỗi');
                }
            });
        }
        
        function showAddCardModal() {
            editingCardId = null;
            document.getElementById('cardModalTitle').textContent = 'Thêm thẻ mới';
            resetCardForm();
            cardModal.show();
        }
        
        function editCard(id, concept, define) {
            editingCardId = id;
            document.getElementById('cardModalTitle').textContent = 'Sửa thẻ';
            document.getElementById('card-concept').value = concept;
            document.getElementById('card-define').value = define;
            cardModal.show();
        }
        
        async function deleteCard(id) {
            if (await Utils.confirm('Bạn có chắc muốn xóa thẻ này?')) {
                try {
                    await API.deleteFlashcard(id);
                    Utils.success('Xóa thành công!');
                    loadFlashcards();
                } catch (error) {
                    Utils.error(error.message || 'Lỗi');
                }
            }
        }
        
        function resetCardForm() {
            document.getElementById('card-concept').value = '';
            document.getElementById('card-define').value = '';
            document.getElementById('card-image').value = '';
        }
    </script>
</body>
</html>