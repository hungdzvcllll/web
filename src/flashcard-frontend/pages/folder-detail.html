<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chi ti·∫øt th∆∞ m·ª•c - FlashCard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="../css/style.css" rel="stylesheet">
</head>
<body>
    <div id="navbar-container"></div>
    <div id="sidebar-container"></div>
    
    <main class="main-content">
        <div class="page-header">
            <nav class="breadcrumb-custom"><ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="dashboard.html">Trang ch·ªß</a></li>
                <li class="breadcrumb-item"><a href="folders.html">Th∆∞ m·ª•c</a></li>
                <li class="breadcrumb-item active" id="breadcrumb-name">Loading...</li>
            </ol></nav>
            <div class="d-flex justify-content-between align-items-start flex-wrap gap-3">
                <div>
                    <h1 id="folder-title"><i class="fas fa-folder text-warning me-2"></i>Loading...</h1>
                    <p id="folder-description">ƒêang t·∫£i th√¥ng tin...</p>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-custom" onclick="showInviteModal()">
                        <i class="fas fa-user-plus me-1"></i> M·ªùi
                    </button>
                    <button class="btn btn-primary-custom" onclick="showCreateStudySetModal()">
                        <i class="fas fa-plus me-1"></i> T·∫°o b·ªô h·ªçc
                    </button>
                </div>
            </div>
        </div>
        
        <div id="studysets-container" class="row g-4">
            <div class="col-12"><div class="loading-spinner"><div class="spinner"></div></div></div>
        </div>
        <div id="pagination-container" class="mt-4"></div>
    </main>
    
    <!-- Create Study Set Modal -->
    <div class="modal fade modal-custom" id="createStudySetModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">T·∫°o b·ªô h·ªçc m·ªõi</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="create-studyset-form">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="studyset-name" class="form-label">T√™n b·ªô h·ªçc</label>
                            <input type="text" class="form-control" id="studyset-name" placeholder="V√≠ d·ª•: T·ª´ v·ª±ng TOEIC" required>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">H·ªßy</button>
                        <button type="submit" class="btn btn-primary-custom"><i class="fas fa-plus me-1"></i> T·∫°o</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Invite Modal -->
    <div class="modal fade modal-custom" id="inviteModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">M·ªùi ng∆∞·ªùi d√πng</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="invite-form">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="invite-user-id" class="form-label">ID ng∆∞·ªùi d√πng</label>
                            <input type="number" class="form-control" id="invite-user-id" placeholder="Nh·∫≠p ID ng∆∞·ªùi d√πng" required>
                        </div>
                        <div class="alert alert-info small">
                            <i class="fas fa-info-circle me-1"></i> Ng∆∞·ªùi ƒë∆∞·ª£c m·ªùi s·∫Ω c√≥ quy·ªÅn xem v√† h·ªçc c√°c b·ªô flashcard trong th∆∞ m·ª•c n√†y.
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">H·ªßy</button>
                        <button type="submit" class="btn btn-primary-custom"><i class="fas fa-paper-plane me-1"></i> M·ªùi</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/config.js"></script>
    <script src="../js/api.js"></script>
    <script src="../js/utils.js"></script>
    <script src="../js/app.js"></script>
    
    <script>
        let createStudySetModal, inviteModal;
        let folderId, folderData;
        
        document.addEventListener('DOMContentLoaded', async function() {
            if (!Utils.requireAuth()) return;
            
            folderId = Utils.getUrlParam('id');
            if (!folderId) {
                Utils.error('Kh√¥ng t√¨m th·∫•y th∆∞ m·ª•c');
                window.location.href = 'folders.html';
                return;
            }
            
            createStudySetModal = new bootstrap.Modal(document.getElementById('createStudySetModal'));
            inviteModal = new bootstrap.Modal(document.getElementById('inviteModal'));
            
            await loadFolderDetail();
            await loadStudySets();
            setupEventListeners();
        });
        
        async function loadFolderDetail() {
            try {
                folderData = await API.getFolderById(folderId);
                document.getElementById('folder-title').innerHTML = `<i class="fas fa-folder text-warning me-2"></i>${Utils.escapeHtml(folderData.name)}`;
                document.getElementById('breadcrumb-name').textContent = folderData.name;
                document.getElementById('folder-description').textContent = folderData.isPrivate ? 'üîí Th∆∞ m·ª•c ri√™ng t∆∞' : 'üåê Th∆∞ m·ª•c c√¥ng khai';
            } catch (error) {
                Utils.error('Kh√¥ng th·ªÉ t·∫£i th√¥ng tin th∆∞ m·ª•c');
            }
        }
        
        async function loadStudySets(page = 0) {
            const container = document.getElementById('studysets-container');
            container.innerHTML = '<div class="col-12"><div class="loading-spinner"><div class="spinner"></div></div></div>';
            
            try {
                const response = await API.getStudySetsByFolder(folderId, page, 12);
                const studySets = response.content || [];
                
                if (studySets.length === 0) {
                    container.innerHTML = `<div class="col-12"><div class="empty-state">
                        <div class="empty-state-icon"><i class="fas fa-layer-group"></i></div>
                        <h3>Ch∆∞a c√≥ b·ªô h·ªçc n√†o</h3>
                        <p>T·∫°o b·ªô h·ªçc ƒë·∫ßu ti√™n trong th∆∞ m·ª•c n√†y</p>
                        <button class="btn btn-primary-custom" onclick="showCreateStudySetModal()"><i class="fas fa-plus me-1"></i> T·∫°o b·ªô h·ªçc</button>
                    </div></div>`;
                    return;
                }
                
                container.innerHTML = studySets.map(ss => `
                    <div class="col-sm-6 col-lg-4">
                        <div class="card-custom studyset-card h-100" onclick="location.href='studyset-detail.html?id=${ss.id}'">
                            <div class="card-body">
                                <div class="studyset-header">
                                    <div class="studyset-icon"><i class="fas fa-layer-group"></i></div>
                                    <div class="studyset-info flex-grow-1">
                                        <h5>${Utils.escapeHtml(ss.name)}</h5>
                                        <span>B·ªô h·ªçc</span>
                                    </div>
                                    <div class="dropdown" onclick="event.stopPropagation()">
                                        <button class="btn btn-sm btn-link text-muted p-0" data-bs-toggle="dropdown">
                                            <i class="fas fa-ellipsis-v"></i>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end">
                                            <li><a class="dropdown-item text-danger" href="#" onclick="deleteStudySet(${ss.id}, '${Utils.escapeHtml(ss.name)}')"><i class="fas fa-trash me-2"></i>X√≥a</a></li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="d-flex gap-2 mt-3">
                                    <button class="btn btn-sm btn-outline-primary flex-fill" onclick="event.stopPropagation(); location.href='study.html?id=${ss.id}'">
                                        <i class="fas fa-graduation-cap me-1"></i> H·ªçc
                                    </button>
                                    <button class="btn btn-sm btn-outline-success flex-fill" onclick="event.stopPropagation(); location.href='quiz.html?id=${ss.id}'">
                                        <i class="fas fa-clipboard-check me-1"></i> Quiz
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
                
                Utils.renderPagination('#pagination-container', page, response.totalPages, loadStudySets);
            } catch (error) {
                container.innerHTML = '<div class="col-12"><p class="text-center text-muted">Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu</p></div>';
            }
        }
        
        function setupEventListeners() {
            document.getElementById('create-studyset-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                const name = document.getElementById('studyset-name').value.trim();
                if (!name) { Utils.error('Vui l√≤ng nh·∫≠p t√™n'); return; }
                try {
                    await API.createStudySet(folderId, name);
                    Utils.success('T·∫°o b·ªô h·ªçc th√†nh c√¥ng!');
                    createStudySetModal.hide();
                    document.getElementById('studyset-name').value = '';
                    loadStudySets();
                } catch (error) { Utils.error(error.message || 'L·ªói'); }
            });
            
            document.getElementById('invite-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                const userId = document.getElementById('invite-user-id').value;
                if (!userId) { Utils.error('Vui l√≤ng nh·∫≠p ID'); return; }
                try {
                    await API.inviteToFolder(userId, folderId);
                    Utils.success('M·ªùi th√†nh c√¥ng!');
                    inviteModal.hide();
                    document.getElementById('invite-user-id').value = '';
                } catch (error) { Utils.error(error.message || 'L·ªói'); }
            });
        }
        
        function showCreateStudySetModal() { createStudySetModal.show(); }
        function showInviteModal() { inviteModal.show(); }
        
        // Th√™m function x√≥a study set
        async function deleteStudySet(id, name) {
            if (!confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a b·ªô h·ªçc "${name}"?\nT·∫•t c·∫£ th·∫ª flashcard trong b·ªô h·ªçc c≈©ng s·∫Ω b·ªã x√≥a!`)) {
                return;
            }
            try {
                await API.deleteStudySet(id);
                Utils.success('ƒê√£ x√≥a b·ªô h·ªçc th√†nh c√¥ng!');
                loadStudySets();
            } catch (error) {
                Utils.error(error.message || 'Kh√¥ng th·ªÉ x√≥a b·ªô h·ªçc');
            }
        }
    </script>
</body>
</html>